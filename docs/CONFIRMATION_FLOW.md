# 订单确认流程 - 可视化示例

## 🎬 完整对话示例（带状态标注）

### 示例 1: 理想流程（用户一次性提供所有信息）

```
┌─────────────────────────────────────────────────────────────┐
│ 轮次 1                                                       │
├─────────────────────────────────────────────────────────────┤
│ 用户: "我要一杯大杯乌龙奶茶，三分糖，去冰，加珍珠"           │
│                                                             │
│ 系统分析:                                                    │
│   ✓ drink_name = "乌龙奶茶"                                 │
│   ✓ size = "大杯"                                           │
│   ✓ sugar = "三分糖"                                        │
│   ✓ ice = "去冰"                                            │
│   ✓ toppings = ["珍珠"]                                     │
│   ✓ is_complete = true                                     │
│                                                             │
│ AI 回复:                                                     │
│   "好的！为您下单：                                          │
│    • 饮品：大杯乌龙奶茶                                      │
│    • 甜度：三分糖                                            │
│    • 冰块：去冰                                              │
│    • 加料：珍珠                                              │
│                                                             │
│    请问确认下单吗？"                                         │
│                                                             │
│ 状态: OrderStatus.CONFIRMING                               │
│ 动作: AgentAction.CONFIRM                                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 轮次 2                                                       │
├─────────────────────────────────────────────────────────────┤
│ 用户: "确认"                                                 │
│                                                             │
│ 系统分析:                                                    │
│   ✓ 上一轮 action = "confirm"                              │
│   ✓ 用户确认意图明确                                         │
│   → 触发保存订单                                             │
│                                                             │
│ AI 回复:                                                     │
│   "好的，订单已确认！您的订单是：                            │
│    大杯乌龙奶茶，三分糖，去冰，加珍珠。                      │
│    订单号：#1234                                             │
│    请稍等，马上为您准备！"                                   │
│                                                             │
│ 后端操作:                                                    │
│   1. 调用 db.save_order()                                  │
│   2. 生成订单号 1234                                        │
│   3. 更新状态为 OrderStatus.SAVED                          │
│                                                             │
│ 状态: OrderStatus.SAVED                                    │
│ 动作: AgentAction.SAVE_ORDER                               │
│ 订单号: #1234                                               │
└─────────────────────────────────────────────────────────────┘

✅ 流程完成！订单已保存到数据库
```

---

### 示例 2: 逐步收集（多轮对话）

```
┌─────────────────────────────────────────────────────────────┐
│ 轮次 1                                                       │
├─────────────────────────────────────────────────────────────┤
│ 用户: "我要一杯奶茶"                                         │
│                                                             │
│ 系统分析:                                                    │
│   ✗ drink_name = null (未指定具体饮品)                      │
│   ✗ size = null                                            │
│   ✗ sugar = null                                           │
│   ✗ ice = null                                             │
│   → 需要继续询问                                             │
│                                                             │
│ AI 回复:                                                     │
│   "好的！请问您想要哪一款呢？                                │
│    我们有乌龙奶茶、茉莉奶绿、红茶拿铁、抹茶拿铁等。"         │
│                                                             │
│ 状态: OrderStatus.COLLECTING                               │
│ 动作: AgentAction.ASK_MORE                                 │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 轮次 2                                                       │
├─────────────────────────────────────────────────────────────┤
│ 用户: "乌龙奶茶"                                             │
│                                                             │
│ 系统分析:                                                    │
│   ✓ drink_name = "乌龙奶茶"                                 │
│   ✗ size = null                                            │
│   ✗ sugar = null                                           │
│   ✗ ice = null                                             │
│   → 继续收集其他信息                                         │
│                                                             │
│ AI 回复:                                                     │
│   "好的，乌龙奶茶！                                          │
│    请问您要什么杯型？我们有小杯、中杯、大杯。                │
│    甜度和冰块呢？"                                           │
│                                                             │
│ 状态: OrderStatus.COLLECTING                               │
│ 动作: AgentAction.ASK_MORE                                 │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 轮次 3                                                       │
├─────────────────────────────────────────────────────────────┤
│ 用户: "大杯，三分糖，去冰"                                   │
│                                                             │
│ 系统分析:                                                    │
│   ✓ drink_name = "乌龙奶茶"                                 │
│   ✓ size = "大杯"                                           │
│   ✓ sugar = "三分糖"                                        │
│   ✓ ice = "去冰"                                            │
│   ✓ toppings = []                                          │
│   → 基本信息齐全，询问加料                                   │
│                                                             │
│ AI 回复:                                                     │
│   "好的！为您确认一下：大杯乌龙奶茶，三分糖，去冰。          │
│    请问需要加料吗？比如珍珠、布丁、仙草等。"                 │
│                                                             │
│ 状态: OrderStatus.COLLECTING                               │
│ 动作: AgentAction.ASK_MORE                                 │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 轮次 4                                                       │
├─────────────────────────────────────────────────────────────┤
│ 用户: "加珍珠"                                               │
│                                                             │
│ 系统分析:                                                    │
│   ✓ drink_name = "乌龙奶茶"                                 │
│   ✓ size = "大杯"                                           │
│   ✓ sugar = "三分糖"                                        │
│   ✓ ice = "去冰"                                            │
│   ✓ toppings = ["珍珠"]                                     │
│   ✓ is_complete = true                                     │
│   → 所有信息齐全，进入确认阶段                               │
│                                                             │
│ AI 回复:                                                     │
│   "好的！为您下单：                                          │
│    • 饮品：大杯乌龙奶茶                                      │
│    • 甜度：三分糖                                            │
│    • 冰块：去冰                                              │
│    • 加料：珍珠                                              │
│                                                             │
│    请问确认下单吗？"                                         │
│                                                             │
│ 状态: OrderStatus.CONFIRMING                               │
│ 动作: AgentAction.CONFIRM                                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 轮次 5                                                       │
├─────────────────────────────────────────────────────────────┤
│ 用户: "确认"                                                 │
│                                                             │
│ AI 回复:                                                     │
│   "好的，订单已确认！订单号：#1235"                          │
│                                                             │
│ 状态: OrderStatus.SAVED                                    │
│ 动作: AgentAction.SAVE_ORDER                               │
│ 订单号: #1235                                               │
└─────────────────────────────────────────────────────────────┘

✅ 流程完成！5轮对话完成订单
```

---

### 示例 3: 修改订单（确认阶段修改）

```
┌─────────────────────────────────────────────────────────────┐
│ 轮次 1-3: (省略收集过程)                                     │
├─────────────────────────────────────────────────────────────┤
│ 当前订单状态:                                                │
│   drink_name = "茉莉奶绿"                                   │
│   size = "中杯"                                             │
│   sugar = "五分糖"                                          │
│   ice = "少冰"                                              │
│   toppings = []                                            │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 轮次 4: 进入确认阶段                                         │
├─────────────────────────────────────────────────────────────┤
│ AI 回复:                                                     │
│   "好的！为您下单：                                          │
│    • 饮品：中杯茉莉奶绿                                      │
│    • 甜度：五分糖                                            │
│    • 冰块：少冰                                              │
│                                                             │
│    请问确认下单吗？"                                         │
│                                                             │
│ 状态: OrderStatus.CONFIRMING                               │
│ 动作: AgentAction.CONFIRM                                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 轮次 5: 用户要求修改                                         │
├─────────────────────────────────────────────────────────────┤
│ 用户: "等等，我要七分糖，还要加布丁"                         │
│                                                             │
│ 系统分析:                                                    │
│   → 用户要修改订单                                           │
│   → 更新 sugar = "七分糖"                                   │
│   → 更新 toppings = ["布丁"]                                │
│   → 重新进入确认阶段                                         │
│                                                             │
│ AI 回复:                                                     │
│   "好的，已修改为七分糖，加布丁。                            │
│    为您确认：                                                │
│    • 饮品：中杯茉莉奶绿                                      │
│    • 甜度：七分糖 ← 已修改                                   │
│    • 冰块：少冰                                              │
│    • 加料：布丁 ← 已添加                                     │
│                                                             │
│    请问这样可以吗？"                                         │
│                                                             │
│ 订单状态已更新:                                              │
│   sugar = "七分糖"                                          │
│   toppings = ["布丁"]                                       │
│                                                             │
│ 状态: OrderStatus.CONFIRMING                               │
│ 动作: AgentAction.CONFIRM                                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 轮次 6: 再次确认                                             │
├─────────────────────────────────────────────────────────────┤
│ 用户: "可以了"                                               │
│                                                             │
│ AI 回复:                                                     │
│   "好的，订单已确认！                                        │
│    您的订单是：中杯茉莉奶绿，七分糖，少冰，加布丁。          │
│    订单号：#1236"                                            │
│                                                             │
│ 状态: OrderStatus.SAVED                                    │
│ 动作: AgentAction.SAVE_ORDER                               │
│ 订单号: #1236                                               │
└─────────────────────────────────────────────────────────────┘

✅ 流程完成！支持确认阶段修改
```

---

## 🔄 状态机图

```
                    ┌──────────────┐
                    │   开始对话   │
                    └──────┬───────┘
                           │
                           ▼
        ┌──────────────────────────────────┐
        │      COLLECTING (收集信息)        │
        │  action = "ask_more"             │
        │                                  │
        │  • 询问缺失字段                   │
        │  • 支持多轮对话                   │
        │  • 可一次提供多个信息              │
        └──────────────┬──────────────────┘
                       │
                       │ 所有必填信息已收集
                       │ is_complete = true
                       ▼
        ┌──────────────────────────────────┐
        │     CONFIRMING (等待确认)         │◄───┐
        │  action = "confirm"              │    │
        │                                  │    │
        │  • 完整复述订单                   │    │
        │  • 询问用户确认                   │    │
        │  • 允许修改                       │    │
        └──────────────┬──────────────────┘    │
                       │                        │
                       │ 用户确认               │ 用户要修改
                       │ "确认"/"对"/"可以"      │ "改成xxx"
                       ▼                        │
        ┌──────────────────────────────────┐   │
        │       SAVED (已保存)              │   │
        │  action = "save_order"           │   │
        │                                  │   │
        │  • 保存到数据库                   │   │
        │  • 返回订单号                     │   │
        │  • 完成流程                       │   │
        └──────────────┬──────────────────┘   │
                       │                        │
                       │                        │
                       ▼                        │
                    结束 ─────────────────────┘
```

---

## 📊 关键数据流

### 1. 订单状态的演变

```
空订单
{
  "drink_name": null,
  "size": null,
  "sugar": null,
  "ice": null,
  "toppings": [],
  "notes": null,
  "is_complete": false
}
       ↓ 用户: "我要乌龙奶茶"
部分订单
{
  "drink_name": "乌龙奶茶",
  "size": null,
  "sugar": null,
  "ice": null,
  "toppings": [],
  "notes": null,
  "is_complete": false
}
       ↓ 用户: "大杯，三分糖，去冰"
完整订单
{
  "drink_name": "乌龙奶茶",
  "size": "大杯",
  "sugar": "三分糖",
  "ice": "去冰",
  "toppings": [],
  "notes": null,
  "is_complete": true
}
       ↓ AI: 进入确认阶段
确认阶段
       ↓ 用户: "确认"
保存到数据库
```

---

## 🎯 确认话术模板

### AI 确认时的标准话术

```
"好的！为您下单：
 • 饮品：{size} {drink_name}
 • 甜度：{sugar}
 • 冰块：{ice}
 [可选] • 加料：{toppings}
 [可选] • 备注：{notes}

 请问确认下单吗？"
```

### AI 保存后的标准话术

```
"好的，订单已确认！
 您的订单是：{完整订单信息}
 订单号：#{order_id}
 请稍等，马上为您准备！"
```

---

## ✨ 总结

订单确认的核心机制：

1. **智能判断** - LLM 自动判断何时进入确认阶段
2. **完整复述** - 清晰展示所有订单细节
3. **灵活修改** - 确认阶段允许修改任何字段
4. **明确保存** - 用户确认后才真正保存
5. **即时反馈** - 返回订单号作为凭证

这种机制确保了：
- ✅ 订单准确性（用户可确认和修改）
- ✅ 用户体验（自然的对话流程）
- ✅ 数据完整性（保存前验证）
- ✅ 灵活性（支持各种对话方式）
